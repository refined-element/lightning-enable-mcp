name: Publish MCP Packages

on:
  push:
    branches: [main]
    paths:
      - 'dotnet/src/LightningEnable.Mcp/LightningEnable.Mcp.csproj'
      - 'python/lightning-enable-mcp/pyproject.toml'
      - 'python/lightning-enable-mcp/Dockerfile'
    tags:
      - 'mcp-v*'
  workflow_dispatch:
    inputs:
      publish_nuget:
        description: 'Publish to NuGet'
        required: false
        default: 'true'
        type: boolean
      publish_pypi:
        description: 'Publish to PyPI'
        required: false
        default: 'true'
        type: boolean
      publish_docker:
        description: 'Publish to Docker Hub'
        required: false
        default: 'true'
        type: boolean

env:
  DOTNET_VERSION: '9.0.x'
  PYTHON_VERSION: '3.11'

jobs:
  publish-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag or csproj
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/mcp-v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/mcp-v}"
          else
            VERSION=$(grep -oP '(?<=<Version>)[^<]+' dotnet/src/LightningEnable.Mcp/LightningEnable.Mcp.csproj)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build and publish .NET MCP
        if: github.event_name == 'push' || github.event.inputs.publish_nuget == 'true'
        run: |
          cd dotnet/src/LightningEnable.Mcp
          dotnet restore
          dotnet build --configuration Release --no-restore
          dotnet pack --configuration Release --no-build --output ./nupkg

          echo "=== Publishing to NuGet ==="
          dotnet nuget push ./nupkg/*.nupkg \
            --api-key ${{ secrets.NUGET_API_KEY }} \
            --source https://api.nuget.org/v3/index.json \
            --skip-duplicate

          echo "=== NuGet Package Published ==="
          echo "Package: LightningEnable.Mcp"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "URL: https://www.nuget.org/packages/LightningEnable.Mcp"

      - name: Build and publish Python MCP
        if: github.event_name == 'push' || github.event.inputs.publish_pypi == 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd python/lightning-enable-mcp
          pip install build twine
          python -m build

          echo "=== Publishing to PyPI ==="
          twine upload --skip-existing dist/*

          echo "=== PyPI Package Published ==="
          echo "Package: lightning-enable-mcp"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "URL: https://pypi.org/project/lightning-enable-mcp"

  publish-docker:
    runs-on: ubuntu-latest
    needs: publish-packages
    if: github.event_name == 'push' || github.event.inputs.publish_docker == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: refinedelement/lightning-enable-mcp
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ needs.publish-packages.outputs.version }}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: python/lightning-enable-mcp
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  publish-registry:
    runs-on: ubuntu-latest
    needs: [publish-packages, publish-docker]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install mcp-publisher
        run: |
          curl -sL "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher

      - name: Authenticate to MCP Registry
        run: ./mcp-publisher login github-oidc

      - name: Update server.json version
        run: |
          VERSION="${{ needs.publish-packages.outputs.version }}"
          jq --arg v "$VERSION" '
            .version = $v |
            .packages[0].version = $v |
            .packages[1].version = $v |
            (.packages[2].identifier = "docker.io/refinedelement/lightning-enable-mcp:" + $v)
          ' server.json > server.tmp && mv server.tmp server.json
          echo "Publishing version $VERSION to MCP Registry"
          cat server.json | jq '.version, .packages[].version'

      - name: Wait for NuGet to index version
        run: |
          VERSION="${{ needs.publish-packages.outputs.version }}"
          echo "Waiting for NuGet to index version $VERSION..."
          for i in $(seq 1 20); do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://api.nuget.org/v3-flatcontainer/lightningenable.mcp/$VERSION/lightningenable.mcp.nuspec")
            if [ "$STATUS" = "200" ]; then
              echo "NuGet version $VERSION is available"
              break
            fi
            echo "Attempt $i/20: NuGet returned $STATUS, waiting 15s..."
            sleep 15
          done

      - name: Publish to MCP Registry
        run: ./mcp-publisher publish --file=server.json

  summary:
    runs-on: ubuntu-latest
    needs: [publish-packages, publish-docker, publish-registry]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## MCP Package Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.publish-packages.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Install Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Command |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| .NET | \`dotnet tool install --global LightningEnable.Mcp\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Python | \`pip install lightning-enable-mcp\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | \`docker pull refinedelement/lightning-enable-mcp:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [NuGet](https://www.nuget.org/packages/LightningEnable.Mcp)" >> $GITHUB_STEP_SUMMARY
          echo "- [PyPI](https://pypi.org/project/lightning-enable-mcp)" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Hub](https://hub.docker.com/r/refinedelement/lightning-enable-mcp)" >> $GITHUB_STEP_SUMMARY
          echo "- [MCP Registry](https://registry.modelcontextprotocol.io)" >> $GITHUB_STEP_SUMMARY
